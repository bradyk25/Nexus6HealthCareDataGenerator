<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nexus Analytics - Healthcare Intelligence</title>
    
    <!-- Professional Chart.js Integration -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    
    <!-- Feather Icons for Clean Look -->
    <script src="https://unpkg.com/feather-icons"></script>
    
    <style>
        /* Modern Minimalist Design System */
        :root {
            /* Light Color Palette */
            --white: #ffffff;
            --light-gray: #f8f9fa;
            --very-light-gray: #f5f6f7;
            --medium-gray: #e9ecef;
            --border-gray: #dee2e6;
            --text-light: #6c757d;
            --text-medium: #495057;
            --text-dark: #343a40;
            --charcoal: #2c3e50;
            --dark-charcoal: #1a252f;
            
            /* Deep Teal Accent */
            --accent-teal: #008B8B;
            --accent-teal-hover: #006666;
            --accent-teal-light: rgba(0, 139, 139, 0.1);
            --accent-teal-border: rgba(0, 139, 139, 0.2);
            
            /* Typography */
            --font-primary: 'Montserrat', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            
            /* Spacing System */
            --space-1: 0.25rem;
            --space-2: 0.5rem;
            --space-3: 0.75rem;
            --space-4: 1rem;
            --space-5: 1.25rem;
            --space-6: 1.5rem;
            --space-8: 2rem;
            --space-10: 2.5rem;
            --space-12: 3rem;
            --space-16: 4rem;
            
            /* Border Radius */
            --radius-sm: 0.25rem;
            --radius-md: 0.5rem;
            --radius-lg: 0.75rem;
            --radius-xl: 1rem;
            
            /* Shadows */
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.1);
            --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.1);
        }

        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800;900&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-primary);
            background: var(--white);
            color: var(--charcoal);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Thin Horizontal Dashboard */
        .dashboard {
            background: var(--white);
            border-bottom: 1px solid var(--border-gray);
            padding: var(--space-3) var(--space-6);
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow-sm);
        }

        .dashboard-container {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: var(--space-3);
        }

        .logo {
            width: 32px;
            height: 32px;
            background: var(--accent-teal);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--white);
            font-weight: 700;
            font-size: 0.875rem;
        }

        .brand-name {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--charcoal);
        }

        .dashboard-status {
            display: flex;
            align-items: center;
            gap: var(--space-4);
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            font-size: 0.875rem;
            color: var(--text-medium);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--accent-teal);
        }

        /* File Input Area */
        .file-input-section {
            max-width: 1400px;
            margin: 0 auto;
            padding: var(--space-8) var(--space-6);
        }

        .file-input-container {
            background: var(--very-light-gray);
            border: 2px dashed var(--border-gray);
            border-radius: var(--radius-lg);
            padding: var(--space-10);
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .file-input-container:hover {
            border-color: var(--accent-teal);
            background: var(--accent-teal-light);
        }

        .file-input-container.dragover {
            border-color: var(--accent-teal);
            background: var(--accent-teal-light);
        }

        .file-input-icon {
            font-size: 2.5rem;
            color: var(--text-light);
            margin-bottom: var(--space-4);
        }

        .file-input-text {
            font-size: 1.125rem;
            color: var(--text-dark);
            margin-bottom: var(--space-6);
        }

        .file-input-button {
            background: var(--accent-teal);
            color: var(--white);
            border: none;
            padding: var(--space-3) var(--space-6);
            border-radius: var(--radius-md);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .file-input-button:hover {
            background: var(--accent-teal-hover);
        }

        .file-formats {
            margin-top: var(--space-4);
            font-size: 0.875rem;
            color: var(--text-light);
        }

        /* Analytics Tabs */
        .analytics-tabs {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 var(--space-6) var(--space-6);
            display: none;
        }

        .tabs-container {
            display: flex;
            gap: var(--space-1);
            background: var(--very-light-gray);
            padding: var(--space-1);
            border-radius: var(--radius-lg);
            margin-bottom: var(--space-8);
        }

        .tab-button {
            flex: 1;
            padding: var(--space-3) var(--space-4);
            border: none;
            background: transparent;
            color: var(--text-medium);
            font-weight: 500;
            font-size: 0.875rem;
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-2);
        }

        .tab-button:hover {
            color: var(--text-dark);
        }

        .tab-button.active {
            background: var(--accent-teal);
            color: var(--white);
        }

        /* Split-View Interface */
        .split-view {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: var(--space-6);
            height: 600px;
        }

        .analytics-panel {
            background: var(--white);
            border: 1px solid var(--border-gray);
            border-radius: var(--radius-lg);
            padding: var(--space-6);
            overflow: hidden;
        }

        .chatbot-panel {
            background: var(--white);
            border: 1px solid var(--border-gray);
            border-radius: var(--radius-lg);
            display: flex;
            flex-direction: column;
        }

        /* Analytics Content */
        .analytics-content {
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .analytics-header {
            margin-bottom: var(--space-6);
        }

        .analytics-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--charcoal);
            margin-bottom: var(--space-2);
        }

        .analytics-subtitle {
            color: var(--text-medium);
            font-size: 0.875rem;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--space-4);
            margin-bottom: var(--space-6);
        }

        .metric-card {
            background: var(--very-light-gray);
            padding: var(--space-4);
            border-radius: var(--radius-md);
            text-align: center;
        }

        .metric-value {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--accent-teal);
            margin-bottom: var(--space-1);
        }

        .metric-label {
            font-size: 0.75rem;
            color: var(--text-medium);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 600;
        }

        .chart-container {
            flex: 1;
            position: relative;
            min-height: 300px;
        }

        /* Chatbot Interface */
        .chatbot-header {
            padding: var(--space-4) var(--space-6);
            border-bottom: 1px solid var(--border-gray);
            background: var(--very-light-gray);
            border-radius: var(--radius-lg) var(--radius-lg) 0 0;
        }

        .chatbot-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--charcoal);
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }

        .chatbot-icon {
            width: 20px;
            height: 20px;
            background: var(--accent-teal);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--white);
            font-size: 0.75rem;
        }

        .chat-messages {
            flex: 1;
            padding: var(--space-4);
            overflow-y: auto;
            max-height: 400px;
            display: flex;
            flex-direction: column;
            gap: var(--space-3);
            scroll-behavior: smooth;
        }

        .chat-message {
            max-width: 80%;
            padding: var(--space-3) var(--space-4);
            border-radius: var(--radius-lg);
            font-size: 0.875rem;
            line-height: 1.4;
        }

        .chat-message.user {
            align-self: flex-end;
            background: var(--accent-teal);
            color: var(--white);
        }

        .chat-message.bot {
            align-self: flex-start;
            background: var(--medium-gray);
            color: var(--text-dark);
        }

        .chat-input-container {
            padding: var(--space-4);
            border-top: 1px solid var(--border-gray);
            display: flex;
            gap: var(--space-2);
        }

        .chat-input {
            flex: 1;
            padding: var(--space-3);
            border: 1px solid var(--border-gray);
            border-radius: var(--radius-md);
            font-size: 0.875rem;
            outline: none;
            transition: border-color 0.2s ease;
        }

        .chat-input:focus {
            border-color: var(--accent-teal);
        }

        .chat-send-button {
            background: var(--accent-teal);
            color: var(--white);
            border: none;
            padding: var(--space-3);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: background-color 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .chat-send-button:hover {
            background: var(--accent-teal-hover);
        }

        .chat-send-button:disabled {
            background: var(--text-light);
            cursor: not-allowed;
        }

        /* Processing States */
        .processing-state {
            display: none;
            text-align: center;
            padding: var(--space-10);
        }

        .processing-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border-gray);
            border-top: 3px solid var(--accent-teal);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto var(--space-4);
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .processing-text {
            color: var(--text-medium);
            font-size: 0.875rem;
        }

        /* Tab Content */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .split-view {
                grid-template-columns: 1fr;
                height: auto;
            }
            
            .analytics-panel {
                height: 400px;
            }
            
            .chatbot-panel {
                height: 300px;
            }
            
            .metrics-grid {
                grid-template-columns: 1fr;
            }
            
            .dashboard-container {
                flex-direction: column;
                gap: var(--space-3);
                text-align: center;
            }
            
            .tabs-container {
                flex-direction: column;
            }
        }

        /* Synthesis Input Section */
        .synthesis-input-section {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 var(--space-6) var(--space-8);
            display: none;
        }

        .synthesis-input-container {
            background: var(--white);
            border: 1px solid var(--border-gray);
            border-radius: var(--radius-lg);
            padding: var(--space-6);
            text-align: center;
        }

        .synthesis-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--charcoal);
            margin-bottom: var(--space-2);
        }

        .synthesis-subtitle {
            color: var(--text-medium);
            font-size: 0.875rem;
            margin-bottom: var(--space-6);
        }

        .synthesis-input-group {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-4);
            margin-bottom: var(--space-6);
        }

        .synthesis-input-label {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-dark);
        }

        .synthesis-input {
            padding: var(--space-3) var(--space-4);
            border: 1px solid var(--border-gray);
            border-radius: var(--radius-md);
            font-size: 1rem;
            width: 120px;
            text-align: center;
            outline: none;
            transition: border-color 0.2s ease;
        }

        .synthesis-input:focus {
            border-color: var(--accent-teal);
        }

        .synthesis-generate-button {
            background: var(--accent-teal);
            color: var(--white);
            border: none;
            padding: var(--space-3) var(--space-6);
            border-radius: var(--radius-md);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }

        .synthesis-generate-button:hover {
            background: var(--accent-teal-hover);
        }

        .synthesis-generate-button:disabled {
            background: var(--text-light);
            cursor: not-allowed;
        }

        /* Utility Classes */
        .hidden {
            display: none !important;
        }

        .fade-in {
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* AI Connection Status */
        .ai-status {
            font-size: 0.75rem;
            color: var(--text-light);
            margin-left: var(--space-2);
        }

        .ai-status.connected {
            color: var(--accent-teal);
        }

        .ai-status.disconnected {
            color: #dc3545;
        }
    </style>
</head>
<body>
    <!-- Thin Horizontal Dashboard -->
    <header class="dashboard">
        <div class="dashboard-container">
            <div class="logo-section">
                <div class="logo">N</div>
                <div class="brand-name">Nexus Analytics</div>
            </div>
            <div class="dashboard-status">
                <div class="status-indicator">
                    <div class="status-dot"></div>
                    <span>System Online</span>
                </div>
            </div>
        </div>
    </header>

    <!-- File Input Area -->
    <section class="file-input-section">
        <div class="file-input-container" id="fileInputContainer">
            <div class="file-input-icon">📁</div>
            <div class="file-input-text">
                <strong>Upload your healthcare data file</strong><br>
                Drag and drop or click to browse
            </div>
            <input type="file" id="fileInput" accept=".zip,.csv,.xlsx" style="display: none;" />
            <button class="file-input-button" onclick="document.getElementById('fileInput').click()">
                Choose File
            </button>
            <div class="file-formats">
                Supported formats: ZIP, CSV, XLSX
            </div>
        </div>
    </section>

    <!-- Synthesis Input Section -->
    <section class="synthesis-input-section" id="synthesisInputSection">
        <div class="synthesis-input-container">
            <h3 class="synthesis-title">Generate Synthetic Data</h3>
            <p class="synthesis-subtitle">Your data has been sanitized and is ready for synthesis. How many rows would you like to generate?</p>
            
            <div class="synthesis-input-group">
                <label class="synthesis-input-label" for="synthesisAmount">Number of rows:</label>
                <input type="number" id="synthesisAmount" class="synthesis-input" value="1000" min="100" max="100000" step="100">
            </div>
            
            <button class="synthesis-generate-button" id="generateSynthesisButton" onclick="generateSyntheticData()">
                <i data-feather="cpu"></i>
                Generate Synthetic Data
            </button>
        </div>
    </section>

    <!-- Analytics Tabs -->
    <section class="analytics-tabs" id="analyticsTabs">
        <div class="tabs-container">
            <button class="tab-button active" onclick="switchTab('quality')" data-tab="quality">
                <i data-feather="check-circle"></i>
                Data Quality
            </button>
            <button class="tab-button" onclick="switchTab('privacy')" data-tab="privacy">
                <i data-feather="shield"></i>
                Privacy Analytics
            </button>
            <button class="tab-button" onclick="switchTab('distribution')" data-tab="distribution">
                <i data-feather="bar-chart-2"></i>
                Distribution
            </button>
            <button class="tab-button" onclick="switchTab('synthesis')" data-tab="synthesis" id="synthesisTab" style="display: none;">
                <i data-feather="database"></i>
                Data Synthesis
            </button>
        </div>

        <!-- Split-View Interface -->
        <div class="split-view">
            <!-- Analytics Panel (Left) -->
            <div class="analytics-panel">
                <!-- Data Quality Tab -->
                <div id="quality" class="tab-content active">
                    <div class="analytics-content">
                        <div class="analytics-header">
                            <h2 class="analytics-title">Data Quality Assessment</h2>
                            <p class="analytics-subtitle">Comprehensive analysis of your healthcare data quality</p>
                        </div>
                        
                        <div class="metrics-grid">
                            <div class="metric-card">
                                <div class="metric-value" id="qualityScore">94%</div>
                                <div class="metric-label">Overall Quality</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-value" id="completeness">96%</div>
                                <div class="metric-label">Completeness</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-value" id="accuracy">92%</div>
                                <div class="metric-label">Accuracy</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-value" id="consistency">98%</div>
                                <div class="metric-label">Consistency</div>
                            </div>
                        </div>
                        
                        <div class="chart-container">
                            <canvas id="qualityChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Privacy Analytics Tab -->
                <div id="privacy" class="tab-content">
                    <div class="analytics-content">
                        <div class="analytics-header">
                            <h2 class="analytics-title">Privacy Analytics</h2>
                            <p class="analytics-subtitle">HIPAA compliance and privacy risk assessment</p>
                        </div>
                        
                        <div class="metrics-grid">
                            <div class="metric-card">
                                <div class="metric-value" id="privacyScore">98%</div>
                                <div class="metric-label">Privacy Score</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-value" id="sensitiveFields">3</div>
                                <div class="metric-label">Sensitive Fields</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-value" id="riskLevel">Low</div>
                                <div class="metric-label">Risk Level</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-value" id="compliance">✓</div>
                                <div class="metric-label">HIPAA Compliant</div>
                            </div>
                        </div>
                        
                        <div class="chart-container">
                            <canvas id="privacyChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Distribution Analysis Tab -->
                <div id="distribution" class="tab-content">
                    <div class="analytics-content">
                        <div class="analytics-header">
                            <h2 class="analytics-title">Data Distribution</h2>
                            <p class="analytics-subtitle">Statistical distribution and column analysis</p>
                        </div>
                        
                        <div class="metrics-grid">
                            <div class="metric-card">
                                <div class="metric-value" id="totalColumns">15</div>
                                <div class="metric-label">Total Columns</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-value" id="numericalCols">8</div>
                                <div class="metric-label">Numerical</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-value" id="categoricalCols">5</div>
                                <div class="metric-label">Categorical</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-value" id="dateCols">2</div>
                                <div class="metric-label">Date Fields</div>
                            </div>
                        </div>
                        
                        <div class="chart-container">
                            <canvas id="distributionChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Data Synthesis Tab -->
                <div id="synthesis" class="tab-content">
                    <div class="analytics-content">
                        <div class="analytics-header">
                            <h2 class="analytics-title">Data Synthesis</h2>
                            <p class="analytics-subtitle">Generated synthetic healthcare data ready for download</p>
                        </div>
                        
                        <div class="metrics-grid">
                            <div class="metric-card">
                                <div class="metric-value" id="synthesisRows">1,000</div>
                                <div class="metric-label">Rows Generated</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-value" id="synthesisColumns">15</div>
                                <div class="metric-label">Columns</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-value" id="synthesisSize">2.4MB</div>
                                <div class="metric-label">File Size</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-value" id="synthesisStatus">✓</div>
                                <div class="metric-label">Ready</div>
                            </div>
                        </div>
                        
                        <div style="text-align: center; margin-top: var(--space-8);">
                            <button class="synthesis-generate-button" id="downloadSynthesisButton" onclick="downloadSyntheticData()">
                                <i data-feather="download"></i>
                                Download Synthetic Data (CSV)
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Processing State -->
                <div id="processingState" class="processing-state">
                    <div class="processing-spinner"></div>
                    <div class="processing-text">Analyzing your healthcare data...</div>
                </div>

                <!-- Synthesis Processing State -->
                <div id="synthesisProcessingState" class="processing-state">
                    <div class="processing-spinner"></div>
                    <div class="processing-text">Generating synthetic data...</div>
                </div>
            </div>

            <!-- Chatbot Panel (Right) -->
            <div class="chatbot-panel">
                <div class="chatbot-header">
                    <div class="chatbot-title">
                        <div class="chatbot-icon">🤖</div>
                        Healthcare Analytics Assistant
                        <span class="ai-status" id="aiStatus">Connecting...</span>
                    </div>
                </div>
                
                <div class="chat-messages" id="chatMessages">
                    <div class="chat-message bot">
                        Hello! I'm your healthcare analytics assistant powered by Phara AI. I can help you understand your data quality metrics, privacy compliance, and distribution patterns. What would you like to know?
                    </div>
                </div>
                
                <div class="chat-input-container">
                    <input type="text" class="chat-input" id="chatInput" placeholder="Ask about your data..." />
                    <button class="chat-send-button" id="chatSendButton">
                        <i data-feather="send"></i>
                    </button>
                </div>
            </div>
        </div>
    </section>

    <script>
        // Global variables
        let currentFile = null;
        let charts = {};
        let isProcessing = false;
        let isAIConnected = false;
        const API_BASE = 'http://localhost:5001/api';

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            feather.replace();
            initializeEventListeners();
            initializeChatbot();
            checkAIConnection();
        });

        // Check AI connection
        async function checkAIConnection() {
            try {
                const response = await fetch(`${API_BASE}/health`);
                const data = await response.json();
                
                if (data.status === 'healthy') {
                    isAIConnected = true;
                    updateAIStatus('connected', 'Phara AI Connected');
                } else {
                    throw new Error('API not healthy');
                }
            } catch (error) {
                console.error('Failed to connect to Phara AI:', error);
                isAIConnected = false;
                updateAIStatus('disconnected', 'AI Offline');
            }
        }

        // Update AI connection status
        function updateAIStatus(status, message) {
            const statusElement = document.getElementById('aiStatus');
            statusElement.className = `ai-status ${status}`;
            statusElement.textContent = message;
        }

        // Initialize event listeners
        function initializeEventListeners() {
            const fileInput = document.getElementById('fileInput');
            const fileInputContainer = document.getElementById('fileInputContainer');
            
            // File input handling
            fileInput.addEventListener('change', handleFileSelect);
            
            // Drag and drop functionality
            fileInputContainer.addEventListener('dragover', handleDragOver);
            fileInputContainer.addEventListener('dragleave', handleDragLeave);
            fileInputContainer.addEventListener('drop', handleFileDrop);
            
            // Chat functionality
            const chatInput = document.getElementById('chatInput');
            const chatSendButton = document.getElementById('chatSendButton');
            
            chatInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendChatMessage();
                }
            });
            
            chatSendButton.addEventListener('click', sendChatMessage);
        }

        // File handling functions
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                processFile(file);
            }
        }

        function handleDragOver(event) {
            event.preventDefault();
            event.currentTarget.classList.add('dragover');
        }

        function handleDragLeave(event) {
            event.currentTarget.classList.remove('dragover');
        }

        function handleFileDrop(event) {
            event.preventDefault();
            event.currentTarget.classList.remove('dragover');
            
            const files = event.dataTransfer.files;
            if (files.length > 0) {
                processFile(files[0]);
            }
        }

        // File processing
        async function processFile(file) {
            if (isProcessing) return;
            
            currentFile = file;
            isProcessing = true;
            
            // Show analytics tabs and processing state
            document.getElementById('analyticsTabs').style.display = 'block';
            document.getElementById('processingState').style.display = 'block';
            
            // Hide tab content during processing
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.style.display = 'none';
            });
            
            // Add chat message about file processing
            addChatMessage('bot', `Processing ${file.name}... I'll analyze the data quality, privacy compliance, and distribution patterns for you.`);
            
            try {
                // Upload file to API for real analysis
                const formData = new FormData();
                formData.append('file', file);
                
                const response = await fetch(`${API_BASE}/files/upload`, {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.error) {
                    throw new Error(result.error);
                }
                
                // Update UI with real analysis results
                updateAnalyticsWithRealData(result);
                
                // Add success message to chat
                addChatMessage('bot', `Analysis complete! ${result.message || 'Your healthcare data has been successfully analyzed and loaded into my system.'}`);
                
                // Show results after processing
                setTimeout(() => {
                    showResults();
                    isProcessing = false;
                }, 1000);
                
            } catch (error) {
                console.error('File upload error:', error);
                addChatMessage('bot', `I encountered an error processing your file: ${error.message}. Please try again or check that the file format is supported.`);
                
                // Fallback to simulated processing
                setTimeout(() => {
                    showResults();
                    isProcessing = false;
                }, 2000);
            }
        }

        // Update analytics with real data from API
        function updateAnalyticsWithRealData(analysisResult) {
            if (analysisResult.analysis) {
                const analysis = analysisResult.analysis;
                
                // Update quality metrics if available
                if (analysis.quality_score !== undefined) {
                    document.getElementById('qualityScore').textContent = `${Math.round(analysis.quality_score)}%`;
                }
                if (analysis.completeness !== undefined) {
                    document.getElementById('completeness').textContent = `${Math.round(analysis.completeness)}%`;
                }
                if (analysis.accuracy !== undefined) {
                    document.getElementById('accuracy').textContent = `${Math.round(analysis.accuracy)}%`;
                }
                if (analysis.consistency !== undefined) {
                    document.getElementById('consistency').textContent = `${Math.round(analysis.consistency)}%`;
                }
                
                // Update privacy metrics if available
                if (analysis.privacy_score !== undefined) {
                    document.getElementById('privacyScore').textContent = `${Math.round(analysis.privacy_score)}%`;
                }
                if (analysis.sensitive_fields !== undefined) {
                    document.getElementById('sensitiveFields').textContent = analysis.sensitive_fields;
                }
                if (analysis.risk_level !== undefined) {
                    document.getElementById('riskLevel').textContent = analysis.risk_level;
                }
                
                // Update distribution metrics if available
                if (analysis.total_columns !== undefined) {
                    document.getElementById('totalColumns').textContent = analysis.total_columns;
                }
                if (analysis.numerical_cols !== undefined) {
                    document.getElementById('numericalCols').textContent = analysis.numerical_cols;
                }
                if (analysis.categorical_cols !== undefined) {
                    document.getElementById('categoricalCols').textContent = analysis.categorical_cols;
                }
                if (analysis.date_cols !== undefined) {
                    document.getElementById('dateCols').textContent = analysis.date_cols;
                }
            }
        }

        // Show processing results
        function showResults() {
            // Hide processing state
            document.getElementById('processingState').style.display = 'none';
            
            // Show active tab content
            const activeTab = document.querySelector('.tab-content.active');
            if (activeTab) {
                activeTab.style.display = 'block';
            }
            
            // Create charts
            createCharts();
            
            // Show synthesis input section
            document.getElementById('synthesisInputSection').style.display = 'block';
            
            // Replace feather icons
            feather.replace();
        }

        // Tab switching functionality
        function switchTab(tabName) {
            if (isProcessing) return;
            
            // Update tab buttons
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });
            
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            
            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
                content.style.display = 'none';
            });
            
            const selectedTab = document.getElementById(tabName);
            if (selectedTab) {
                selectedTab.classList.add('active');
                selectedTab.style.display = 'block';
            }
            
            // Add chat message about tab switch
            const tabNames = {
                'quality': 'Data Quality Assessment',
                'privacy': 'Privacy Analytics',
                'distribution': 'Data Distribution Analysis'
            };
            
            addChatMessage('bot', `Switched to ${tabNames[tabName]}. This view shows ${getTabDescription(tabName)}`);
        }

        function getTabDescription(tabName) {
            const descriptions = {
                'quality': 'comprehensive data quality metrics including completeness, accuracy, and consistency scores.',
                'privacy': 'HIPAA compliance status, privacy risk assessment, and sensitive field detection.',
                'distribution': 'statistical distribution of your data columns and field type analysis.',
                'synthesis': 'generated synthetic healthcare data ready for download with privacy protection.'
            };
            return descriptions[tabName] || 'detailed analytics for your healthcare data.';
        }

        // Chart creation functions
        function createCharts() {
            // Configure Chart.js for light theme
            Chart.defaults.color = '#495057';
            Chart.defaults.borderColor = '#dee2e6';
            
            createQualityChart();
            createPrivacyChart();
            createDistributionChart();
        }

        function createQualityChart() {
            const ctx = document.getElementById('qualityChart');
            if (!ctx) return;
            
            charts.quality = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Completeness', 'Accuracy', 'Consistency', 'Validity'],
                    datasets: [{
                        label: 'Quality Score (%)',
                        data: [96, 92, 98, 89],
                        backgroundColor: '#008B8B',
                        borderRadius: 4,
                        borderSkipped: false,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            grid: {
                                color: '#f5f6f7'
                            },
                            ticks: {
                                color: '#6c757d'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                color: '#6c757d'
                            }
                        }
                    }
                }
            });
        }

        function createPrivacyChart() {
            const ctx = document.getElementById('privacyChart');
            if (!ctx) return;
            
            charts.privacy = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Compliant Fields', 'Sensitive Fields', 'Protected Fields'],
                    datasets: [{
                        data: [85, 10, 5],
                        backgroundColor: ['#008B8B', '#6c757d', '#e9ecef'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: '#6c757d',
                                usePointStyle: true,
                                padding: 20
                            }
                        }
                    }
                }
            });
        }

        function createDistributionChart() {
            const ctx = document.getElementById('distributionChart');
            if (!ctx) return;
            
            charts.distribution = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['Numerical', 'Categorical', 'Date/Time', 'Text'],
                    datasets: [{
                        data: [8, 5, 2, 3],
                        backgroundColor: ['#008B8B', '#6c757d', '#495057', '#e9ecef'],
                        borderWidth: 2,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: '#6c757d',
                                usePointStyle: true,
                                padding: 20
                            }
                        }
                    }
                }
            });
        }

        // Chatbot functionality
        function initializeChatbot() {
            // Initial setup is already done in HTML
        }

        async function sendChatMessage() {
            const chatInput = document.getElementById('chatInput');
            const chatSendButton = document.getElementById('chatSendButton');
            const message = chatInput.value.trim();
            
            if (!message) return;
            
            // Disable input during processing
            chatInput.disabled = true;
            chatSendButton.disabled = true;
            
            // Add user message
            addChatMessage('user', message);
            chatInput.value = '';
            
            try {
                let response;
                
                if (isAIConnected) {
                    // Send to real Phara AI
                    const apiResponse = await fetch(`${API_BASE}/chat`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ message: message })
                    });
                    
                    const data = await apiResponse.json();
                    
                    if (data.error) {
                        response = `I encountered an error: ${data.error}. Please try again.`;
                    } else {
                        response = data.response;
                    }
                } else {
                    // Fallback to mock responses
                    response = generateBotResponse(message);
                }
                
                // Add bot response
                setTimeout(() => {
                    addChatMessage('bot', response);
                }, 1000);
                
            } catch (error) {
                console.error('Chat error:', error);
                addChatMessage('bot', 'I apologize, but I encountered a connection error. Please ensure the Phara AI server is running and try again.');
            } finally {
                // Re-enable input
                chatInput.disabled = false;
                chatSendButton.disabled = false;
                chatInput.focus();
            }
        }

        function addChatMessage(sender, message) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${sender}`;
            messageDiv.textContent = message;
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function generateBotResponse(userMessage) {
            const message = userMessage.toLowerCase();
            
            // Simple response logic based on keywords
            if (message.includes('quality') || message.includes('score')) {
                return 'Your data quality is excellent with a 94% overall score. Completeness is at 96%, accuracy at 92%, and consistency at 98%. This indicates very reliable healthcare data.';
            } else if (message.includes('privacy') || message.includes('hipaa') || message.includes('compliance')) {
                return 'Your data is fully HIPAA compliant with a 98% privacy score. I detected 3 sensitive fields that are properly protected. Risk level is low, which is excellent for healthcare data.';
            } else if (message.includes('distribution') || message.includes('columns') || message.includes('fields')) {
                return 'Your dataset contains 15 columns total: 8 numerical fields, 5 categorical fields, and 2 date fields. This is a well-structured healthcare dataset with good variety.';
            } else if (message.includes('synthetic') || message.includes('synthesis') || message.includes('generate')) {
                return 'I can help you generate synthetic healthcare data that maintains statistical properties while ensuring privacy. The synthetic data is HIPAA-compliant and ready for research or testing purposes.';
            } else if (message.includes('download') || message.includes('csv')) {
                return 'Once synthetic data generation is complete, you can download the CSV file from the Data Synthesis tab. The file will contain all the columns from your original dataset with synthetic values.';
            } else if (message.includes('help') || message.includes('what') || message.includes('how')) {
                return 'I can help you understand your healthcare data analytics, generate synthetic data, and guide you through the download process. Ask me about data quality, privacy compliance, or synthetic data generation.';
            } else if (message.includes('thank') || message.includes('thanks')) {
                return 'You\'re welcome! I\'m here to help you understand your healthcare data analytics and assist with synthetic data generation. Feel free to ask any other questions.';
            } else {
                return 'I can help you with data quality analysis, privacy compliance, distribution insights, and synthetic data generation. Try asking about specific metrics or the synthesis process.';
            }
        }

        // Synthesis functionality
        function generateSyntheticData() {
            const amount = document.getElementById('synthesisAmount').value;
            const button = document.getElementById('generateSynthesisButton');
            
            // Disable button and show processing
            button.disabled = true;
            button.innerHTML = '<i data-feather="loader"></i> Generating...';
            
            // Hide synthesis input and show processing state
            document.getElementById('synthesisInputSection').style.display = 'none';
            document.getElementById('synthesisProcessingState').style.display = 'block';
            
            // Hide all tab content during synthesis
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.style.display = 'none';
            });
            
            // Add chat message
            addChatMessage('bot', `Generating ${formatNumber(amount)} rows of synthetic healthcare data. This may take a moment...`);
            
            // Simulate synthesis processing
            setTimeout(() => {
                showSynthesisResults(amount);
            }, 4000);
            
            feather.replace();
        }

        function showSynthesisResults(amount) {
            // Hide processing state
            document.getElementById('synthesisProcessingState').style.display = 'none';
            
            // Update synthesis metrics
            document.getElementById('synthesisRows').textContent = formatNumber(amount);
            const fileSize = (amount * 0.0024).toFixed(1); // Rough estimate
            document.getElementById('synthesisSize').textContent = `${fileSize}MB`;
            
            // Show synthesis tab and make it visible
            document.getElementById('synthesisTab').style.display = 'flex';
            
            // Switch to synthesis tab
            switchTab('synthesis');
            
            // Add completion message
            addChatMessage('bot', `Synthetic data generation complete! Generated ${formatNumber(amount)} rows of HIPAA-compliant synthetic healthcare data. You can now download the CSV file from the Data Synthesis tab.`);
            
            // Replace feather icons
            feather.replace();
        }

        function downloadSyntheticData() {
            const rows = document.getElementById('synthesisRows').textContent.replace(',', '');
            
            // Generate sample CSV data
            const csvData = generateSampleCSV(parseInt(rows));
            
            // Create and download file
            const blob = new Blob([csvData], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `synthetic_healthcare_data_${rows}_rows.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            // Add chat message
            addChatMessage('bot', `Download started! Your synthetic healthcare dataset with ${formatNumber(rows)} rows is being downloaded as a CSV file.`);
        }

        function generateSampleCSV(numRows) {
            const headers = [
                'patient_id', 'age', 'gender', 'diagnosis_code', 'treatment_type',
                'admission_date', 'discharge_date', 'length_of_stay', 'department',
                'physician_id', 'insurance_type', 'total_cost', 'medication_count',
                'lab_results', 'vital_signs'
            ];
            
            let csv = headers.join(',') + '\n';
            
            const genders = ['Male', 'Female', 'Other'];
            const diagnoses = ['J44.1', 'I25.9', 'E11.9', 'M79.3', 'K59.0', 'F32.9'];
            const treatments = ['Medication', 'Surgery', 'Therapy', 'Observation'];
            const departments = ['Cardiology', 'Endocrinology', 'Orthopedics', 'Psychiatry'];
            const insuranceTypes = ['Medicare', 'Medicaid', 'Private', 'Uninsured'];
            
            for (let i = 1; i <= numRows; i++) {
                const row = [
                    `PAT${String(i).padStart(6, '0')}`,
                    Math.floor(Math.random() * 80) + 18,
                    genders[Math.floor(Math.random() * genders.length)],
                    diagnoses[Math.floor(Math.random() * diagnoses.length)],
                    treatments[Math.floor(Math.random() * treatments.length)],
                    `2024-${String(Math.floor(Math.random() * 12) + 1).padStart(2, '0')}-${String(Math.floor(Math.random() * 28) + 1).padStart(2, '0')}`,
                    `2024-${String(Math.floor(Math.random() * 12) + 1).padStart(2, '0')}-${String(Math.floor(Math.random() * 28) + 1).padStart(2, '0')}`,
                    Math.floor(Math.random() * 14) + 1,
                    departments[Math.floor(Math.random() * departments.length)],
                    `DOC${String(Math.floor(Math.random() * 100) + 1).padStart(3, '0')}`,
                    insuranceTypes[Math.floor(Math.random() * insuranceTypes.length)],
                    (Math.random() * 50000 + 1000).toFixed(2),
                    Math.floor(Math.random() * 10),
                    `Normal-${Math.floor(Math.random() * 100)}`,
                    `BP:${Math.floor(Math.random() * 40) + 100}/${Math.floor(Math.random() * 30) + 60}`
                ];
                csv += row.join(',') + '\n';
            }
            
            return csv;
        }

        // Utility functions
        function formatNumber(num) {
            return new Intl.NumberFormat().format(num);
        }

        function formatPercentage(num) {
            return `${Math.round(num)}%`;
        }
    </script>
</body>
</html>
